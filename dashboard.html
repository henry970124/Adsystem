<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A&D CTF Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; min-height: 100vh; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }
        
        /* 登入頁面 */
        .login-container { max-width: 500px; margin: 100px auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .login-container h1 { color: #667eea; text-align: center; margin-bottom: 30px; }
        .login-form input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        .login-form input:focus { outline: none; border-color: #667eea; }
        .login-form button { width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .login-error { background: #f8d7da; color: #721c24; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: none; }
        
        /* Dashboard */
        .dashboard { display: none; }
        header { background: white; padding: 20px 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        header h1 { color: #667eea; font-size: 2em; }
        .user-info { display: flex; align-items: center; gap: 20px; }
        .user-badge { background: #667eea; color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; }
        .admin-badge { background: #dc3545; }
        .btn-logout { padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; }
        
        /* 遊戲狀態 */
        .game-status { background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px; }
        .status-item { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px; }
        .status-value { font-size: 2em; font-weight: bold; color: #667eea; }
        .status-label { color: #6c757d; margin-top: 5px; }
        
        /* 遊戲控制 (僅 Admin) */
        .game-controls { background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .game-controls h2 { color: #667eea; margin-bottom: 15px; }
        .control-buttons { display: flex; gap: 15px; }
        .btn-start { padding: 12px 30px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-stop { padding: 12px 30px; background: #dc3545; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-start:disabled, .btn-stop:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Patch 上傳 (僅 Team) */
        .patch-upload { background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .patch-upload h2 { color: #667eea; margin-bottom: 15px; }
        .upload-form { display: flex; gap: 15px; align-items: center; }
        .upload-form input[type="file"] { flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px; }
        .btn-upload { padding: 12px 30px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-upload:hover { background: #5568d3; }
        .btn-download { padding: 12px 30px; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-download:hover { background: #218838; }
        .patch-status { margin-top: 15px; padding: 12px; border-radius: 8px; display: none; }
        .patch-success { background: #d4edda; color: #155724; }
        .patch-error { background: #f8d7da; color: #721c24; }
        
        /* Flag 提交 */
        .flag-submit { background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .flag-submit h2 { color: #667eea; margin-bottom: 15px; }
        .flag-form { display: flex; gap: 15px; }
        .flag-form input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        .btn-submit-flag { padding: 12px 30px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .flag-result { margin-top: 15px; padding: 12px; border-radius: 8px; display: none; }
        .flag-success { background: #d4edda; color: #155724; }
        .flag-error { background: #f8d7da; color: #721c24; }
        
        /* Flag 提交記錄 */
        .flag-history { background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .flag-history h2 { color: #667eea; margin-bottom: 15px; }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .history-table th { background: #667eea; color: white; padding: 12px; text-align: left; }
        .history-table td { padding: 12px; border-bottom: 1px solid #ddd; }
        .history-table tr:hover { background: #f8f9fa; }
        
        /* 排行榜 */
        .scoreboard { background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .scoreboard h2 { color: #667eea; margin-bottom: 15px; }
        .scoreboard-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .scoreboard-table th { background: #667eea; color: white; padding: 12px; text-align: left; }
        .scoreboard-table td { padding: 12px; border-bottom: 1px solid #ddd; }
        .rank-1 { background: #ffd700; font-weight: bold; }
        .rank-2 { background: #c0c0c0; }
        .rank-3 { background: #cd7f32; }
        
        /* 服務狀態 */
        .service-status { background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .service-status h2 { color: #667eea; margin-bottom: 15px; }
        .service-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 15px; }
        .service-item { padding: 15px; border-radius: 8px; border: 2px solid #ddd; }
        .service-up { border-color: #28a745; background: #d4edda; }
        .service-down { border-color: #dc3545; background: #f8d7da; }
        .service-name { font-weight: bold; margin-bottom: 5px; }
        .service-time { font-size: 0.9em; color: #6c757d; }
        
        /* Patches 瀏覽 (僅 Team) */
        .patch-browser { background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .patch-browser h2 { color: #667eea; margin-bottom: 15px; }
        .patches-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .patches-table th { background: #667eea; color: white; padding: 12px; text-align: left; }
        .patches-table td { padding: 12px; border-bottom: 1px solid #ddd; }
        .patches-table tr:hover { background: #f8f9fa; }
        .btn-download-patch { padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .btn-download-patch:hover { background: #218838; }
        .no-patches { text-align: center; color: #6c757d; padding: 20px; }

                /* Server Logs (僅 Admin) */
        .server-logs { background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .server-logs h2 { color: #667eea; margin-bottom: 15px; }
        .log-container { background: #000; color: #0f0; padding: 20px; border-radius: 8px; font-family: monospace; max-height: 400px; overflow-y: auto; font-size: 14px; }
        .log-entry { margin: 5px 0; }
        
        /* 響應式 */
        @media (max-width: 768px) {
            .status-grid { grid-template-columns: 1fr; }
            .control-buttons, .flag-form, .upload-form { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 登入頁面 -->
        <div class="login-container" id="loginPage">
            <h1>🔐 A&D CTF 登入</h1>
            <div class="login-error" id="loginError"></div>
            <form class="login-form" id="loginForm">
                <input type="text" id="tokenInput" placeholder="輸入您的 Token" required>
                <button type="submit">登入</button>
            </form>
            <div class="login-hint">
                <strong>💡 提示：</strong>
                <p>• Admin Token: 用於管理遊戲</p>
                <p>• Team Token: 用於參賽隊伍</p>
                <p>請向管理員索取您的專屬 Token</p>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="dashboard" id="dashboard">
            <!-- Header -->
            <header>
                <h1>🚩 A&D CTF Dashboard</h1>
                <div class="user-info">
                    <span class="user-badge" id="userBadge">Loading...</span>
                    <button class="btn-logout" onclick="logout()">登出</button>
                </div>
            </header>

            <!-- 遊戲狀態 -->
            <div class="game-status">
                <h2>📊 遊戲狀態</h2>
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-value" id="gameStatus">未開始</div>
                        <div class="status-label">遊戲狀態</div>
                    </div>
                    <div class="status-item">
                        <div class="status-value" id="currentRound">0</div>
                        <div class="status-label">當前回合</div>
                    </div>
                    <div class="status-item">
                        <div class="status-value" id="timeRemaining">--:--</div>
                        <div class="status-label">剩餘時間</div>
                    </div>
                    <div class="status-item">
                        <div class="status-value" id="phaseStatus">待機中</div>
                        <div class="status-label">階段狀態</div>
                    </div>
                </div>
            </div>

            <!-- 遊戲控制 (僅 Admin) -->
            <div class="game-controls" id="adminControls" style="display: none;">
                <h2>🎮 遊戲控制 (Admin Only)</h2>
                <div class="control-buttons">
                    <button class="btn-start" id="btnStart" onclick="startGame()">開始遊戲</button>
                    <button class="btn-stop" id="btnStop" onclick="stopGame()">停止遊戲</button>
                </div>
            </div>

            <!-- Patch 上傳 (僅 Team) -->
            <div class="patch-upload" id="teamPatchUpload" style="display: none;">
                <h2>🔧 上傳 Patch (修補漏洞)</h2>
                <form class="upload-form" id="patchForm" onsubmit="uploadPatch(event)">
                    <input type="file" id="patchFile" accept=".py" required>
                    <button type="submit" class="btn-upload">上傳 app.py</button>
                    <button type="button" class="btn-download" onclick="downloadPatch()">下載當前 Patch</button>
                </form>
                <div class="patch-status" id="patchStatus"></div>
                <p style="margin-top: 10px; color: #6c757d; font-size: 14px;">
                    ℹ️ 上傳修補過的 app.py，將在下一個 Patch Phase 時套用。可以下載當前已上傳的 Patch 進行修改。
                </p>
            </div>

            <!-- Flag 提交 (僅 Team) -->
            <div class="flag-submit" id="teamFlagSubmit" style="display: none;">
                <h2>🚩 提交 Flag</h2>
                <form class="flag-form" onsubmit="submitFlag(event)">
                    <input type="text" id="flagInput" placeholder="FLAG{...}" required>
                    <button type="submit" class="btn-submit-flag">提交</button>
                </form>
                <div class="flag-result" id="flagResult"></div>
            </div>

            <!-- Patches 瀏覽 (僅 Team) -->
            <div class="patch-browser" id="teamPatchBrowser" style="display: none;">
                <h2>📦 瀏覽其他隊伍的 Patches</h2>
                <p style="color: #6c757d; margin-bottom: 15px;">
                    查看並下載其他隊伍上傳的 patches，學習他們的防禦策略。
                </p>
                <table class="patches-table">
                    <thead>
                        <tr>
                            <th>隊伍</th>
                            <th>檔案名稱</th>
                            <th>大小</th>
                            <th>上傳時間</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="patchesTableBody">
                        <tr><td colspan="5" class="no-patches">載入中...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Flag 提交記錄 -->
            <div class="flag-history">
                <h2>📜 Flag 提交記錄</h2>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>時間</th>
                            <th>攻擊者</th>
                            <th>受害者</th>
                            <th>Flag</th>
                            <th>狀態</th>
                        </tr>
                    </thead>
                    <tbody id="flagHistoryBody">
                        <tr><td colspan="5" style="text-align: center; color: #6c757d;">暫無記錄</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- 即時排行榜 -->
            <div class="scoreboard">
                <h2>📊 即時排行榜</h2>
                <table class="scoreboard-table">
                    <thead>
                        <tr>
                            <th>排名</th>
                            <th>隊伍</th>
                            <th>狀態</th>
                            <th>SLA</th>
                            <th>防禦</th>
                            <th>攻擊</th>
                            <th>總分</th>
                        </tr>
                    </thead>
                    <tbody id="scoreboardBody">
                        <tr><td colspan="7" style="text-align: center; color: #6c757d;">載入中...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- 服務狀態 -->
            <div class="service-status">
                <h2>🖥️ 服務狀態</h2>
                <div class="service-grid" id="serviceGrid">
                    <p style="color: #6c757d;">載入中...</p>
                </div>
            </div>

            <!-- Server Logs (僅 Admin) -->
            <div class="server-logs" id="adminLogs" style="display: none;">
                <h2>📋 Server Logs</h2>
                <div class="log-container" id="logContainer">
                    <div class="log-entry">等待日誌...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js" onerror="console.log('Socket.IO 載入失敗，將使用輪詢模式')"></script>
    <script>
        let currentToken = '';
        let userRole = '';
        let teamId = '';
        let socket = null;
        
        // 保存所有 setInterval ID 以便清除
        let intervals = {
            gameStatus: null,
            scoreboard: null,
            serviceStatus: null,
            flagHistory: null,
            serverLogs: null
        };

        // 從 Cookie 獲取 Token
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // 執行登入邏輯（可被表單和自動登入使用）
        async function performLogin(token) {
            try {
                const response = await fetch('/api/auth/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                
                const result = await response.json();
                
                if (result.valid) {
                    // 清除舊的定時器（防止重複登入時堆疊）
                    clearAllIntervals();
                    
                    currentToken = token;
                    userRole = result.role;
                    teamId = result.team_id || '';
                    
                    // 隱藏登入頁面，顯示 Dashboard
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    
                    // 顯示身份標記
                    const badge = document.getElementById('userBadge');
                    if (userRole === 'admin') {
                        badge.textContent = '👑 Admin';
                        badge.classList.add('admin-badge');
                        document.getElementById('adminControls').style.display = 'block';
                        document.getElementById('adminLogs').style.display = 'block';
                    } else {
                        badge.textContent = `👥 ${teamId}`;
                        document.getElementById('teamPatchUpload').style.display = 'block';
                        document.getElementById('teamPatchBrowser').style.display = 'block';
                        document.getElementById('teamFlagSubmit').style.display = 'block';
                    }
                    
                    // 初始化 Socket.IO
                    initSocket();
                    
                    // 載入數據
                    loadGameStatus();
                    loadScoreboard();
                    loadServiceStatus();
                    loadFlagHistory();
                    if (userRole === 'admin') loadServerLogs();
                    
                    // 開始定時更新（保存 interval ID）
                    intervals.gameStatus = setInterval(loadGameStatus, 2000);
                    intervals.scoreboard = setInterval(loadScoreboard, 5000);
                    intervals.serviceStatus = setInterval(loadServiceStatus, 10000);
                    intervals.flagHistory = setInterval(loadFlagHistory, 5000);
                    if (userRole === 'team') {
                        loadPatchesList();
                        intervals.patchesList = setInterval(loadPatchesList, 10000);
                    }
                    if (userRole === 'admin') {
                        intervals.serverLogs = setInterval(loadServerLogs, 3000);
                    }
                    
                    // 保存 Token 到 Cookie (7天有效)
                    document.cookie = `ad_token=${token}; max-age=${7*24*60*60}; path=/`;
                    
                    return true;
                } else {
                    document.getElementById('loginError').textContent = '❌ Token 無效，請檢查後重試';
                    document.getElementById('loginError').style.display = 'block';
                    return false;
                }
            } catch (error) {
                document.getElementById('loginError').textContent = '❌ 連線錯誤: ' + error.message;
                document.getElementById('loginError').style.display = 'block';
                return false;
            }
        }

        // 自動登入（如果有 Cookie）
        window.addEventListener('DOMContentLoaded', async () => {
            const savedToken = getCookie('ad_token');
            if (savedToken) {
                console.log('發現已保存的 Token，嘗試自動登入...');
                const success = await performLogin(savedToken);
                if (success) {
                    console.log('自動登入成功！');
                } else {
                    console.log('自動登入失敗，Token 可能已過期');
                    // 清除無效的 Cookie
                    document.cookie = 'ad_token=; max-age=0; path=/';
                }
            }
        });

        // 登入表單提交
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = document.getElementById('tokenInput').value.trim();
            await performLogin(token);
        });

        // 登出
        function logout() {
            // 清除所有定時器
            clearAllIntervals();
            
            if (socket) socket.disconnect();
            currentToken = '';
            userRole = '';
            teamId = '';
            // 刪除 Cookie
            document.cookie = 'ad_token=; max-age=0; path=/';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('tokenInput').value = '';
        }
        
        // 清除所有定時器
        function clearAllIntervals() {
            for (let key in intervals) {
                if (intervals[key]) {
                    clearInterval(intervals[key]);
                    intervals[key] = null;
                }
            }
        }

        // 初始化 Socket.IO (可選)
        function initSocket() {
            try {
                if (typeof io !== 'undefined') {
                    socket = io();
                    socket.on('scoreboard_updated', () => {
                        loadScoreboard();
                    });
                    socket.on('flag_captured', (data) => {
                        loadFlagHistory();
                        loadScoreboard();
                    });
                    socket.on('game_started', () => {
                        loadGameStatus();
                    });
                    console.log('Socket.IO 已連接');
                } else {
                    console.log('Socket.IO 未載入，使用輪詢模式');
                }
            } catch (error) {
                console.log('Socket.IO 初始化失敗，使用輪詢模式:', error);
            }
        }

        // 載入遊戲狀態
        async function loadGameStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // 更新遊戲狀態
                document.getElementById('gameStatus').textContent = data.game_started ? '進行中' : '未開始';
                document.getElementById('currentRound').textContent = data.current_round || 0;
                
                // 更新階段狀態和剩餘時間
                const phaseElem = document.getElementById('phaseStatus');
                const timeElem = document.getElementById('timeRemaining');
                
                if (!data.game_started || !data.round_info) {
                    phaseElem.textContent = '待機中';
                    timeElem.textContent = '--:--';
                } else {
                    // 更新階段
                    if (data.round_info.phase === 'playing') {
                        phaseElem.textContent = '🎯 遊戲階段';
                    } else if (data.round_info.phase === 'patching') {
                        phaseElem.textContent = '🔧 補丁階段';
                    } else {
                        phaseElem.textContent = '⏸️ 等待中';
                    }
                    
                    // 更新剩餘時間
                    const remaining = data.round_info.remaining_seconds || 0;
                    const minutes = Math.floor(remaining / 60);
                    const seconds = remaining % 60;
                    timeElem.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }
                
                // 更新按鈕狀態
                if (userRole === 'admin') {
                    document.getElementById('btnStart').disabled = data.game_started;
                    document.getElementById('btnStop').disabled = !data.game_started;
                }
            } catch (error) {
                console.error('載入遊戲狀態失敗:', error);
            }
        }

        // 載入排行榜
        async function loadScoreboard() {
            try {
                const response = await fetch('/api/scoreboard');
                const data = await response.json();
                
                const tbody = document.getElementById('scoreboardBody');
                if (data.scoreboard && data.scoreboard.length > 0) {
                    tbody.innerHTML = data.scoreboard.map((team, index) => `
                        <tr class="${index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : ''}">
                            <td>${index + 1}</td>
                            <td>${team.name}</td>
                            <td>${team.is_up ? '🟢 在線' : '🔴 離線'}</td>
                            <td>${team.total_sla || 0}</td>
                            <td>${team.total_defense || 0}</td>
                            <td>${team.total_attack || 0}</td>
                            <td><strong>${team.total_score || 0}</strong></td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #6c757d;">暫無數據</td></tr>';
                }
            } catch (error) {
                console.error('載入排行榜失敗:', error);
            }
        }

        // 載入服務狀態
        async function loadServiceStatus() {
            try {
                const response = await fetch('/api/service-status');
                const data = await response.json();
                
                const grid = document.getElementById('serviceGrid');
                if (data.services && data.services.length > 0) {
                    grid.innerHTML = data.services.map(service => `
                        <div class="service-item ${service.is_up ? 'service-up' : 'service-down'}">
                            <div class="service-name">${service.team_name}</div>
                            <div>${service.is_up ? '🟢 在線' : '🔴 離線'}</div>
                            <div class="service-time">${service.response_time ? service.response_time + 'ms' : 'N/A'}</div>
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = '<p style="color: #6c757d;">暫無服務數據</p>';
                }
            } catch (error) {
                console.error('載入服務狀態失敗:', error);
            }
        }

        // 載入 Flag 提交記錄
        async function loadFlagHistory() {
            try {
                const response = await fetch('/api/flag/history');
                const data = await response.json();
                
                const tbody = document.getElementById('flagHistoryBody');
                if (data.history && data.history.length > 0) {
                    tbody.innerHTML = data.history.slice(0, 20).map(entry => `
                        <tr>
                            <td>${entry.timestamp}</td>
                            <td>${entry.attacker_team}</td>
                            <td>${entry.victim_team}</td>
                            <td style="font-family: monospace; font-size: 0.9em;">${entry.flag.substring(0, 30)}...</td>
                            <td>${entry.success ? '✅ 成功' : '❌ 失敗'}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6c757d;">暫無記錄</td></tr>';
                }
            } catch (error) {
                console.error('載入 Flag 記錄失敗:', error);
            }
        }

        // 載入 Server Logs (Admin)
        async function loadServerLogs() {
            // 雙重檢查：只有 admin 才能調用此函數
            if (userRole !== 'admin') {
                console.warn('loadServerLogs 被非 admin 用戶調用，已阻止');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/logs', {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        console.error('未授權訪問日誌');
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                const container = document.getElementById('logContainer');
                if (data.logs && data.logs.length > 0) {
                    container.innerHTML = data.logs.map(log => 
                        `<div class="log-entry">${log}</div>`
                    ).join('');
                    container.scrollTop = container.scrollHeight;
                }
            } catch (error) {
                console.error('載入日誌失敗:', error);
            }
        }

        // 載入 Patches 列表 (Team)
        async function loadPatchesList() {
            if (userRole !== 'team') return;

            try {
                const response = await fetch(`/api/patch/list?token=${currentToken}`);
                const data = await response.json();

                const tbody = document.getElementById('patchesTableBody');
                if (data.success && data.patches && data.patches.length > 0) {
                    tbody.innerHTML = data.patches.map(patch => `
                        <tr>
                            <td>${patch.team_name}</td>
                            <td style="font-family: monospace; font-size: 0.9em;">${patch.filename}</td>
                            <td>${formatFileSize(patch.size)}</td>
                            <td>${patch.upload_time}</td>
                            <td>
                                <button class="btn-download-patch" onclick="downloadOtherTeamPatch(${patch.team_id}, '${patch.team_name}')">
                                    ⬇️ 下載
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="no-patches">目前沒有任何隊伍上傳 Patch</td></tr>';
                }
            } catch (error) {
                console.error('載入 Patches 列表失敗:', error);
                document.getElementById('patchesTableBody').innerHTML = 
                    '<tr><td colspan="5" class="no-patches">載入失敗</td></tr>';
            }
        }

        // 格式化檔案大小
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // 下載其他隊伍的 Patch
        async function downloadOtherTeamPatch(teamId, teamName) {
            try {
                const response = await fetch(`/api/patch/download/${teamId}?token=${currentToken}`);

                if (!response.ok) {
                    const result = await response.json();
                    alert('❌ ' + (result.message || '下載失敗'));
                    return;
                }

                // 下載檔案
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `team${teamId}_patch_${new Date().getTime()}.py`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                // 顯示成功提示
                const statusDiv = document.createElement('div');
                statusDiv.className = 'patch-status patch-success';
                statusDiv.textContent = `✅ 成功下載 ${teamName} 的 Patch！`;
                statusDiv.style.position = 'fixed';
                statusDiv.style.top = '20px';
                statusDiv.style.right = '20px';
                statusDiv.style.zIndex = '9999';
                statusDiv.style.padding = '15px 25px';
                statusDiv.style.borderRadius = '8px';
                statusDiv.style.boxShadow = '0 5px 20px rgba(0,0,0,0.2)';
                document.body.appendChild(statusDiv);
                
                setTimeout(() => {
                    statusDiv.remove();
                }, 3000);
            } catch (error) {
                alert('❌ 下載錯誤: ' + error.message);
            }
        }


                // 開始遊戲
        async function startGame() {
            try {
                const response = await fetch('/api/game/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: currentToken })
                });
                const result = await response.json();
                alert(result.message || '遊戲已開始！');
                loadGameStatus();
            } catch (error) {
                alert('啟動遊戲失敗: ' + error.message);
            }
        }

        // 停止遊戲
        async function stopGame() {
            try {
                const response = await fetch('/api/game/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: currentToken })
                });
                const result = await response.json();
                alert(result.message || '遊戲已停止！');
                loadGameStatus();
            } catch (error) {
                alert('停止遊戲失敗: ' + error.message);
            }
        }

        // 提交 Flag
        async function submitFlag(event) {
            event.preventDefault();
            const flag = document.getElementById('flagInput').value.trim();
            const resultDiv = document.getElementById('flagResult');
            
            try {
                const response = await fetch('/api/flag/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: currentToken, flag })
                });
                const result = await response.json();
                
                // 處理成功和錯誤兩種格式
                const message = result.message || result.error || 'Unknown error';
                const isSuccess = result.success || false;
                
                resultDiv.className = 'flag-result ' + (isSuccess ? 'flag-success' : 'flag-error');
                resultDiv.textContent = isSuccess ? `✅ ${message}` : `❌ ${message}`;
                resultDiv.style.display = 'block';
                
                if (isSuccess) {
                    document.getElementById('flagInput').value = '';
                    loadScoreboard();
                    loadFlagHistory();
                }
                
                setTimeout(() => { resultDiv.style.display = 'none'; }, 5000);
            } catch (error) {
                resultDiv.className = 'flag-result flag-error';
                resultDiv.textContent = '❌ 提交錯誤: ' + error.message;
                resultDiv.style.display = 'block';
            }
        }

        // 上傳 Patch
        async function uploadPatch(event) {
            event.preventDefault();
            const fileInput = document.getElementById('patchFile');
            const file = fileInput.files[0];
            const statusDiv = document.getElementById('patchStatus');
            
            if (!file) {
                statusDiv.className = 'patch-status patch-error';
                statusDiv.textContent = '❌ 請選擇文件';
                statusDiv.style.display = 'block';
                return;
            }
            
            const formData = new FormData();
            formData.append('patch', file);
            formData.append('token', currentToken);
            
            try {
                const response = await fetch('/api/patch/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                statusDiv.className = 'patch-status ' + (result.success ? 'patch-success' : 'patch-error');
                statusDiv.textContent = result.message || (result.success ? '✅ Patch 上傳成功！將在下一回合套用' : '❌ 上傳失敗');
                statusDiv.style.display = 'block';
                
                if (result.success) {
                    fileInput.value = '';
                }
                
                setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
            } catch (error) {
                statusDiv.className = 'patch-status patch-error';
                statusDiv.textContent = '❌ 上傳錯誤: ' + error.message;
                statusDiv.style.display = 'block';
            }
        }

        // 下載 Patch
        async function downloadPatch() {
            const statusDiv = document.getElementById('patchStatus');
            
            try {
                const response = await fetch(`/api/patch/download?token=${currentToken}`);
                
                if (!response.ok) {
                    const result = await response.json();
                    statusDiv.className = 'patch-status patch-error';
                    statusDiv.textContent = '❌ ' + (result.message || '下載失敗');
                    statusDiv.style.display = 'block';
                    setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
                    return;
                }
                
                // 下載檔案
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `team_patch_${new Date().getTime()}.py`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                statusDiv.className = 'patch-status patch-success';
                statusDiv.textContent = '✅ Patch 下載成功！';
                statusDiv.style.display = 'block';
                setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
            } catch (error) {
                statusDiv.className = 'patch-status patch-error';
                statusDiv.textContent = '❌ 下載錯誤: ' + error.message;
                statusDiv.style.display = 'block';
            }
        }
    </script>
</body>
</html>
