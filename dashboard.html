<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A&D CTF Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; min-height: 100vh; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }
        
        /* ç™»å…¥é é¢ */
        .login-container { max-width: 500px; margin: 100px auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .login-container h1 { color: #667eea; text-align: center; margin-bottom: 30px; }
        .login-form input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        .login-form input:focus { outline: none; border-color: #667eea; }
        .login-form button { width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .login-error { background: #f8d7da; color: #721c24; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: none; }
        
        /* Dashboard */
        .dashboard { display: none; }
        header { background: white; padding: 20px 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        header h1 { color: #667eea; font-size: 2em; }
        .user-info { display: flex; align-items: center; gap: 20px; }
        .user-badge { background: #667eea; color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; }
        .admin-badge { background: #dc3545; }
        .btn-logout { padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; }
        
        /* éŠæˆ²ç‹€æ…‹ */
        .game-status { background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px; }
        .status-item { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px; }
        .status-value { font-size: 2em; font-weight: bold; color: #667eea; }
        .status-label { color: #6c757d; margin-top: 5px; }
        
        /* éŠæˆ²æ§åˆ¶ (åƒ… Admin) */
        .game-controls { background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .game-controls h2 { color: #667eea; margin-bottom: 15px; }
        .control-buttons { display: flex; gap: 15px; }
        .btn-start { padding: 12px 30px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-stop { padding: 12px 30px; background: #dc3545; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-start:disabled, .btn-stop:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Patch ä¸Šå‚³ (åƒ… Team) */
        .patch-upload { background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .patch-upload h2 { color: #667eea; margin-bottom: 15px; }
        .upload-form { display: flex; gap: 15px; align-items: center; }
        .upload-form input[type="file"] { flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px; }
        .btn-upload { padding: 12px 30px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-upload:hover { background: #5568d3; }
        .btn-download { padding: 12px 30px; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-download:hover { background: #218838; }
        .patch-status { margin-top: 15px; padding: 12px; border-radius: 8px; display: none; }
        .patch-success { background: #d4edda; color: #155724; }
        .patch-error { background: #f8d7da; color: #721c24; }
        
        /* Flag æäº¤ */
        .flag-submit { background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .flag-submit h2 { color: #667eea; margin-bottom: 15px; }
        .flag-form { display: flex; gap: 15px; }
        .flag-form input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        .btn-submit-flag { padding: 12px 30px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .flag-result { margin-top: 15px; padding: 12px; border-radius: 8px; display: none; }
        .flag-success { background: #d4edda; color: #155724; }
        .flag-error { background: #f8d7da; color: #721c24; }
        
        /* Flag æäº¤è¨˜éŒ„ */
        .flag-history { background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .flag-history h2 { color: #667eea; margin-bottom: 15px; }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .history-table th { background: #667eea; color: white; padding: 12px; text-align: left; }
        .history-table td { padding: 12px; border-bottom: 1px solid #ddd; }
        .history-table tr:hover { background: #f8f9fa; }
        
        /* æ’è¡Œæ¦œ */
        .scoreboard { background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .scoreboard h2 { color: #667eea; margin-bottom: 15px; }
        .scoreboard-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .scoreboard-table th { background: #667eea; color: white; padding: 12px; text-align: left; }
        .scoreboard-table td { padding: 12px; border-bottom: 1px solid #ddd; }
        .rank-1 { background: #ffd700; font-weight: bold; }
        .rank-2 { background: #c0c0c0; }
        .rank-3 { background: #cd7f32; }
        
        /* æœå‹™ç‹€æ…‹ */
        .service-status { background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .service-status h2 { color: #667eea; margin-bottom: 15px; }
        .service-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 15px; }
        .service-item { padding: 15px; border-radius: 8px; border: 2px solid #ddd; }
        .service-up { border-color: #28a745; background: #d4edda; }
        .service-down { border-color: #dc3545; background: #f8d7da; }
        .service-name { font-weight: bold; margin-bottom: 5px; }
        .service-time { font-size: 0.9em; color: #6c757d; }
        
        /* Patches ç€è¦½ (åƒ… Team) */
        .patch-browser { background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .patch-browser h2 { color: #667eea; margin-bottom: 15px; }
        .patches-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .patches-table th { background: #667eea; color: white; padding: 12px; text-align: left; }
        .patches-table td { padding: 12px; border-bottom: 1px solid #ddd; }
        .patches-table tr:hover { background: #f8f9fa; }
        .btn-download-patch { padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .btn-download-patch:hover { background: #218838; }
        .no-patches { text-align: center; color: #6c757d; padding: 20px; }

                /* Server Logs (åƒ… Admin) */
        .server-logs { background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .server-logs h2 { color: #667eea; margin-bottom: 15px; }
        .log-container { background: #000; color: #0f0; padding: 20px; border-radius: 8px; font-family: monospace; max-height: 400px; overflow-y: auto; font-size: 14px; }
        .log-entry { margin: 5px 0; }
        
        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 768px) {
            .status-grid { grid-template-columns: 1fr; }
            .control-buttons, .flag-form, .upload-form { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç™»å…¥é é¢ -->
        <div class="login-container" id="loginPage">
            <h1>ğŸ” A&D CTF ç™»å…¥</h1>
            <div class="login-error" id="loginError"></div>
            <form class="login-form" id="loginForm">
                <input type="text" id="tokenInput" placeholder="è¼¸å…¥æ‚¨çš„ Token" required>
                <button type="submit">ç™»å…¥</button>
            </form>
            <div class="login-hint">
                <strong>ğŸ’¡ æç¤ºï¼š</strong>
                <p>â€¢ Admin Token: ç”¨æ–¼ç®¡ç†éŠæˆ²</p>
                <p>â€¢ Team Token: ç”¨æ–¼åƒè³½éšŠä¼</p>
                <p>è«‹å‘ç®¡ç†å“¡ç´¢å–æ‚¨çš„å°ˆå±¬ Token</p>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="dashboard" id="dashboard">
            <!-- Header -->
            <header>
                <h1>ğŸš© A&D CTF Dashboard</h1>
                <div class="user-info">
                    <span class="user-badge" id="userBadge">Loading...</span>
                    <button class="btn-logout" onclick="logout()">ç™»å‡º</button>
                </div>
            </header>

            <!-- éŠæˆ²ç‹€æ…‹ -->
            <div class="game-status">
                <h2>ğŸ“Š éŠæˆ²ç‹€æ…‹</h2>
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-value" id="gameStatus">æœªé–‹å§‹</div>
                        <div class="status-label">éŠæˆ²ç‹€æ…‹</div>
                    </div>
                    <div class="status-item">
                        <div class="status-value" id="currentRound">0</div>
                        <div class="status-label">ç•¶å‰å›åˆ</div>
                    </div>
                    <div class="status-item">
                        <div class="status-value" id="timeRemaining">--:--</div>
                        <div class="status-label">å‰©é¤˜æ™‚é–“</div>
                    </div>
                    <div class="status-item">
                        <div class="status-value" id="phaseStatus">å¾…æ©Ÿä¸­</div>
                        <div class="status-label">éšæ®µç‹€æ…‹</div>
                    </div>
                </div>
            </div>

            <!-- éŠæˆ²æ§åˆ¶ (åƒ… Admin) -->
            <div class="game-controls" id="adminControls" style="display: none;">
                <h2>ğŸ® éŠæˆ²æ§åˆ¶ (Admin Only)</h2>
                <div class="control-buttons">
                    <button class="btn-start" id="btnStart" onclick="startGame()">é–‹å§‹éŠæˆ²</button>
                    <button class="btn-stop" id="btnStop" onclick="stopGame()">åœæ­¢éŠæˆ²</button>
                </div>
            </div>

            <!-- Patch ä¸Šå‚³ (åƒ… Team) -->
            <div class="patch-upload" id="teamPatchUpload" style="display: none;">
                <h2>ğŸ”§ ä¸Šå‚³ Patch (ä¿®è£œæ¼æ´)</h2>
                <form class="upload-form" id="patchForm" onsubmit="uploadPatch(event)">
                    <input type="file" id="patchFile" accept=".py" required>
                    <button type="submit" class="btn-upload">ä¸Šå‚³ app.py</button>
                    <button type="button" class="btn-download" onclick="downloadPatch()">ä¸‹è¼‰ç•¶å‰ Patch</button>
                </form>
                <div class="patch-status" id="patchStatus"></div>
                <p style="margin-top: 10px; color: #6c757d; font-size: 14px;">
                    â„¹ï¸ ä¸Šå‚³ä¿®è£œéçš„ app.pyï¼Œå°‡åœ¨ä¸‹ä¸€å€‹ Patch Phase æ™‚å¥—ç”¨ã€‚å¯ä»¥ä¸‹è¼‰ç•¶å‰å·²ä¸Šå‚³çš„ Patch é€²è¡Œä¿®æ”¹ã€‚
                </p>
            </div>

            <!-- Flag æäº¤ (åƒ… Team) -->
            <div class="flag-submit" id="teamFlagSubmit" style="display: none;">
                <h2>ğŸš© æäº¤ Flag</h2>
                <form class="flag-form" onsubmit="submitFlag(event)">
                    <input type="text" id="flagInput" placeholder="FLAG{...}" required>
                    <button type="submit" class="btn-submit-flag">æäº¤</button>
                </form>
                <div class="flag-result" id="flagResult"></div>
            </div>

            <!-- Patches ç€è¦½ (åƒ… Team) -->
            <div class="patch-browser" id="teamPatchBrowser" style="display: none;">
                <h2>ğŸ“¦ ç€è¦½å…¶ä»–éšŠä¼çš„ Patches</h2>
                <p style="color: #6c757d; margin-bottom: 15px;">
                    æŸ¥çœ‹ä¸¦ä¸‹è¼‰å…¶ä»–éšŠä¼ä¸Šå‚³çš„ patchesï¼Œå­¸ç¿’ä»–å€‘çš„é˜²ç¦¦ç­–ç•¥ã€‚
                </p>
                <table class="patches-table">
                    <thead>
                        <tr>
                            <th>éšŠä¼</th>
                            <th>æª”æ¡ˆåç¨±</th>
                            <th>å¤§å°</th>
                            <th>ä¸Šå‚³æ™‚é–“</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="patchesTableBody">
                        <tr><td colspan="5" class="no-patches">è¼‰å…¥ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Flag æäº¤è¨˜éŒ„ -->
            <div class="flag-history">
                <h2>ğŸ“œ Flag æäº¤è¨˜éŒ„</h2>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>æ™‚é–“</th>
                            <th>æ”»æ“Šè€…</th>
                            <th>å—å®³è€…</th>
                            <th>Flag</th>
                            <th>ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody id="flagHistoryBody">
                        <tr><td colspan="5" style="text-align: center; color: #6c757d;">æš«ç„¡è¨˜éŒ„</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- å³æ™‚æ’è¡Œæ¦œ -->
            <div class="scoreboard">
                <h2>ğŸ“Š å³æ™‚æ’è¡Œæ¦œ</h2>
                <table class="scoreboard-table">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>éšŠä¼</th>
                            <th>ç‹€æ…‹</th>
                            <th>SLA</th>
                            <th>é˜²ç¦¦</th>
                            <th>æ”»æ“Š</th>
                            <th>ç¸½åˆ†</th>
                        </tr>
                    </thead>
                    <tbody id="scoreboardBody">
                        <tr><td colspan="7" style="text-align: center; color: #6c757d;">è¼‰å…¥ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- æœå‹™ç‹€æ…‹ -->
            <div class="service-status">
                <h2>ğŸ–¥ï¸ æœå‹™ç‹€æ…‹</h2>
                <div class="service-grid" id="serviceGrid">
                    <p style="color: #6c757d;">è¼‰å…¥ä¸­...</p>
                </div>
            </div>

            <!-- Server Logs (åƒ… Admin) -->
            <div class="server-logs" id="adminLogs" style="display: none;">
                <h2>ğŸ“‹ Server Logs</h2>
                <div class="log-container" id="logContainer">
                    <div class="log-entry">ç­‰å¾…æ—¥èªŒ...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js" onerror="console.log('Socket.IO è¼‰å…¥å¤±æ•—ï¼Œå°‡ä½¿ç”¨è¼ªè©¢æ¨¡å¼')"></script>
    <script>
        let currentToken = '';
        let userRole = '';
        let teamId = '';
        let socket = null;
        
        // ä¿å­˜æ‰€æœ‰ setInterval ID ä»¥ä¾¿æ¸…é™¤
        let intervals = {
            gameStatus: null,
            scoreboard: null,
            serviceStatus: null,
            flagHistory: null,
            serverLogs: null
        };

        // å¾ Cookie ç²å– Token
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // åŸ·è¡Œç™»å…¥é‚è¼¯ï¼ˆå¯è¢«è¡¨å–®å’Œè‡ªå‹•ç™»å…¥ä½¿ç”¨ï¼‰
        async function performLogin(token) {
            try {
                const response = await fetch('/api/auth/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                
                const result = await response.json();
                
                if (result.valid) {
                    // æ¸…é™¤èˆŠçš„å®šæ™‚å™¨ï¼ˆé˜²æ­¢é‡è¤‡ç™»å…¥æ™‚å †ç–Šï¼‰
                    clearAllIntervals();
                    
                    currentToken = token;
                    userRole = result.role;
                    teamId = result.team_id || '';
                    
                    // éš±è—ç™»å…¥é é¢ï¼Œé¡¯ç¤º Dashboard
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    
                    // é¡¯ç¤ºèº«ä»½æ¨™è¨˜
                    const badge = document.getElementById('userBadge');
                    if (userRole === 'admin') {
                        badge.textContent = 'ğŸ‘‘ Admin';
                        badge.classList.add('admin-badge');
                        document.getElementById('adminControls').style.display = 'block';
                        document.getElementById('adminLogs').style.display = 'block';
                    } else {
                        badge.textContent = `ğŸ‘¥ ${teamId}`;
                        document.getElementById('teamPatchUpload').style.display = 'block';
                        document.getElementById('teamPatchBrowser').style.display = 'block';
                        document.getElementById('teamFlagSubmit').style.display = 'block';
                    }
                    
                    // åˆå§‹åŒ– Socket.IO
                    initSocket();
                    
                    // è¼‰å…¥æ•¸æ“š
                    loadGameStatus();
                    loadScoreboard();
                    loadServiceStatus();
                    loadFlagHistory();
                    if (userRole === 'admin') loadServerLogs();
                    
                    // é–‹å§‹å®šæ™‚æ›´æ–°ï¼ˆä¿å­˜ interval IDï¼‰
                    intervals.gameStatus = setInterval(loadGameStatus, 2000);
                    intervals.scoreboard = setInterval(loadScoreboard, 5000);
                    intervals.serviceStatus = setInterval(loadServiceStatus, 10000);
                    intervals.flagHistory = setInterval(loadFlagHistory, 5000);
                    if (userRole === 'team') {
                        loadPatchesList();
                        intervals.patchesList = setInterval(loadPatchesList, 10000);
                    }
                    if (userRole === 'admin') {
                        intervals.serverLogs = setInterval(loadServerLogs, 3000);
                    }
                    
                    // ä¿å­˜ Token åˆ° Cookie (7å¤©æœ‰æ•ˆ)
                    document.cookie = `ad_token=${token}; max-age=${7*24*60*60}; path=/`;
                    
                    return true;
                } else {
                    document.getElementById('loginError').textContent = 'âŒ Token ç„¡æ•ˆï¼Œè«‹æª¢æŸ¥å¾Œé‡è©¦';
                    document.getElementById('loginError').style.display = 'block';
                    return false;
                }
            } catch (error) {
                document.getElementById('loginError').textContent = 'âŒ é€£ç·šéŒ¯èª¤: ' + error.message;
                document.getElementById('loginError').style.display = 'block';
                return false;
            }
        }

        // è‡ªå‹•ç™»å…¥ï¼ˆå¦‚æœæœ‰ Cookieï¼‰
        window.addEventListener('DOMContentLoaded', async () => {
            const savedToken = getCookie('ad_token');
            if (savedToken) {
                console.log('ç™¼ç¾å·²ä¿å­˜çš„ Tokenï¼Œå˜—è©¦è‡ªå‹•ç™»å…¥...');
                const success = await performLogin(savedToken);
                if (success) {
                    console.log('è‡ªå‹•ç™»å…¥æˆåŠŸï¼');
                } else {
                    console.log('è‡ªå‹•ç™»å…¥å¤±æ•—ï¼ŒToken å¯èƒ½å·²éæœŸ');
                    // æ¸…é™¤ç„¡æ•ˆçš„ Cookie
                    document.cookie = 'ad_token=; max-age=0; path=/';
                }
            }
        });

        // ç™»å…¥è¡¨å–®æäº¤
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = document.getElementById('tokenInput').value.trim();
            await performLogin(token);
        });

        // ç™»å‡º
        function logout() {
            // æ¸…é™¤æ‰€æœ‰å®šæ™‚å™¨
            clearAllIntervals();
            
            if (socket) socket.disconnect();
            currentToken = '';
            userRole = '';
            teamId = '';
            // åˆªé™¤ Cookie
            document.cookie = 'ad_token=; max-age=0; path=/';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('tokenInput').value = '';
        }
        
        // æ¸…é™¤æ‰€æœ‰å®šæ™‚å™¨
        function clearAllIntervals() {
            for (let key in intervals) {
                if (intervals[key]) {
                    clearInterval(intervals[key]);
                    intervals[key] = null;
                }
            }
        }

        // åˆå§‹åŒ– Socket.IO (å¯é¸)
        function initSocket() {
            try {
                if (typeof io !== 'undefined') {
                    socket = io();
                    socket.on('scoreboard_updated', () => {
                        loadScoreboard();
                    });
                    socket.on('flag_captured', (data) => {
                        loadFlagHistory();
                        loadScoreboard();
                    });
                    socket.on('game_started', () => {
                        loadGameStatus();
                    });
                    console.log('Socket.IO å·²é€£æ¥');
                } else {
                    console.log('Socket.IO æœªè¼‰å…¥ï¼Œä½¿ç”¨è¼ªè©¢æ¨¡å¼');
                }
            } catch (error) {
                console.log('Socket.IO åˆå§‹åŒ–å¤±æ•—ï¼Œä½¿ç”¨è¼ªè©¢æ¨¡å¼:', error);
            }
        }

        // è¼‰å…¥éŠæˆ²ç‹€æ…‹
        async function loadGameStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // æ›´æ–°éŠæˆ²ç‹€æ…‹
                document.getElementById('gameStatus').textContent = data.game_started ? 'é€²è¡Œä¸­' : 'æœªé–‹å§‹';
                document.getElementById('currentRound').textContent = data.current_round || 0;
                
                // æ›´æ–°éšæ®µç‹€æ…‹å’Œå‰©é¤˜æ™‚é–“
                const phaseElem = document.getElementById('phaseStatus');
                const timeElem = document.getElementById('timeRemaining');
                
                if (!data.game_started || !data.round_info) {
                    phaseElem.textContent = 'å¾…æ©Ÿä¸­';
                    timeElem.textContent = '--:--';
                } else {
                    // æ›´æ–°éšæ®µ
                    if (data.round_info.phase === 'playing') {
                        phaseElem.textContent = 'ğŸ¯ éŠæˆ²éšæ®µ';
                    } else if (data.round_info.phase === 'patching') {
                        phaseElem.textContent = 'ğŸ”§ è£œä¸éšæ®µ';
                    } else {
                        phaseElem.textContent = 'â¸ï¸ ç­‰å¾…ä¸­';
                    }
                    
                    // æ›´æ–°å‰©é¤˜æ™‚é–“
                    const remaining = data.round_info.remaining_seconds || 0;
                    const minutes = Math.floor(remaining / 60);
                    const seconds = remaining % 60;
                    timeElem.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }
                
                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                if (userRole === 'admin') {
                    document.getElementById('btnStart').disabled = data.game_started;
                    document.getElementById('btnStop').disabled = !data.game_started;
                }
            } catch (error) {
                console.error('è¼‰å…¥éŠæˆ²ç‹€æ…‹å¤±æ•—:', error);
            }
        }

        // è¼‰å…¥æ’è¡Œæ¦œ
        async function loadScoreboard() {
            try {
                const response = await fetch('/api/scoreboard');
                const data = await response.json();
                
                const tbody = document.getElementById('scoreboardBody');
                if (data.scoreboard && data.scoreboard.length > 0) {
                    tbody.innerHTML = data.scoreboard.map((team, index) => `
                        <tr class="${index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : ''}">
                            <td>${index + 1}</td>
                            <td>${team.name}</td>
                            <td>${team.is_up ? 'ğŸŸ¢ åœ¨ç·š' : 'ğŸ”´ é›¢ç·š'}</td>
                            <td>${team.total_sla || 0}</td>
                            <td>${team.total_defense || 0}</td>
                            <td>${team.total_attack || 0}</td>
                            <td><strong>${team.total_score || 0}</strong></td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #6c757d;">æš«ç„¡æ•¸æ“š</td></tr>';
                }
            } catch (error) {
                console.error('è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—:', error);
            }
        }

        // è¼‰å…¥æœå‹™ç‹€æ…‹
        async function loadServiceStatus() {
            try {
                const response = await fetch('/api/service-status');
                const data = await response.json();
                
                const grid = document.getElementById('serviceGrid');
                if (data.services && data.services.length > 0) {
                    grid.innerHTML = data.services.map(service => `
                        <div class="service-item ${service.is_up ? 'service-up' : 'service-down'}">
                            <div class="service-name">${service.team_name}</div>
                            <div>${service.is_up ? 'ğŸŸ¢ åœ¨ç·š' : 'ğŸ”´ é›¢ç·š'}</div>
                            <div class="service-time">${service.response_time ? service.response_time + 'ms' : 'N/A'}</div>
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = '<p style="color: #6c757d;">æš«ç„¡æœå‹™æ•¸æ“š</p>';
                }
            } catch (error) {
                console.error('è¼‰å…¥æœå‹™ç‹€æ…‹å¤±æ•—:', error);
            }
        }

        // è¼‰å…¥ Flag æäº¤è¨˜éŒ„
        async function loadFlagHistory() {
            try {
                const response = await fetch('/api/flag/history');
                const data = await response.json();
                
                const tbody = document.getElementById('flagHistoryBody');
                if (data.history && data.history.length > 0) {
                    tbody.innerHTML = data.history.slice(0, 20).map(entry => `
                        <tr>
                            <td>${entry.timestamp}</td>
                            <td>${entry.attacker_team}</td>
                            <td>${entry.victim_team}</td>
                            <td style="font-family: monospace; font-size: 0.9em;">${entry.flag.substring(0, 30)}...</td>
                            <td>${entry.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6c757d;">æš«ç„¡è¨˜éŒ„</td></tr>';
                }
            } catch (error) {
                console.error('è¼‰å…¥ Flag è¨˜éŒ„å¤±æ•—:', error);
            }
        }

        // è¼‰å…¥ Server Logs (Admin)
        async function loadServerLogs() {
            // é›™é‡æª¢æŸ¥ï¼šåªæœ‰ admin æ‰èƒ½èª¿ç”¨æ­¤å‡½æ•¸
            if (userRole !== 'admin') {
                console.warn('loadServerLogs è¢«é admin ç”¨æˆ¶èª¿ç”¨ï¼Œå·²é˜»æ­¢');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/logs', {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        console.error('æœªæˆæ¬Šè¨ªå•æ—¥èªŒ');
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                const container = document.getElementById('logContainer');
                if (data.logs && data.logs.length > 0) {
                    container.innerHTML = data.logs.map(log => 
                        `<div class="log-entry">${log}</div>`
                    ).join('');
                    container.scrollTop = container.scrollHeight;
                }
            } catch (error) {
                console.error('è¼‰å…¥æ—¥èªŒå¤±æ•—:', error);
            }
        }

        // è¼‰å…¥ Patches åˆ—è¡¨ (Team)
        async function loadPatchesList() {
            if (userRole !== 'team') return;

            try {
                const response = await fetch(`/api/patch/list?token=${currentToken}`);
                const data = await response.json();

                const tbody = document.getElementById('patchesTableBody');
                if (data.success && data.patches && data.patches.length > 0) {
                    tbody.innerHTML = data.patches.map(patch => `
                        <tr>
                            <td>${patch.team_name}</td>
                            <td style="font-family: monospace; font-size: 0.9em;">${patch.filename}</td>
                            <td>${formatFileSize(patch.size)}</td>
                            <td>${patch.upload_time}</td>
                            <td>
                                <button class="btn-download-patch" onclick="downloadOtherTeamPatch(${patch.team_id}, '${patch.team_name}')">
                                    â¬‡ï¸ ä¸‹è¼‰
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="no-patches">ç›®å‰æ²’æœ‰ä»»ä½•éšŠä¼ä¸Šå‚³ Patch</td></tr>';
                }
            } catch (error) {
                console.error('è¼‰å…¥ Patches åˆ—è¡¨å¤±æ•—:', error);
                document.getElementById('patchesTableBody').innerHTML = 
                    '<tr><td colspan="5" class="no-patches">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }

        // æ ¼å¼åŒ–æª”æ¡ˆå¤§å°
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // ä¸‹è¼‰å…¶ä»–éšŠä¼çš„ Patch
        async function downloadOtherTeamPatch(teamId, teamName) {
            try {
                const response = await fetch(`/api/patch/download/${teamId}?token=${currentToken}`);

                if (!response.ok) {
                    const result = await response.json();
                    alert('âŒ ' + (result.message || 'ä¸‹è¼‰å¤±æ•—'));
                    return;
                }

                // ä¸‹è¼‰æª”æ¡ˆ
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `team${teamId}_patch_${new Date().getTime()}.py`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                // é¡¯ç¤ºæˆåŠŸæç¤º
                const statusDiv = document.createElement('div');
                statusDiv.className = 'patch-status patch-success';
                statusDiv.textContent = `âœ… æˆåŠŸä¸‹è¼‰ ${teamName} çš„ Patchï¼`;
                statusDiv.style.position = 'fixed';
                statusDiv.style.top = '20px';
                statusDiv.style.right = '20px';
                statusDiv.style.zIndex = '9999';
                statusDiv.style.padding = '15px 25px';
                statusDiv.style.borderRadius = '8px';
                statusDiv.style.boxShadow = '0 5px 20px rgba(0,0,0,0.2)';
                document.body.appendChild(statusDiv);
                
                setTimeout(() => {
                    statusDiv.remove();
                }, 3000);
            } catch (error) {
                alert('âŒ ä¸‹è¼‰éŒ¯èª¤: ' + error.message);
            }
        }


                // é–‹å§‹éŠæˆ²
        async function startGame() {
            try {
                const response = await fetch('/api/game/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: currentToken })
                });
                const result = await response.json();
                alert(result.message || 'éŠæˆ²å·²é–‹å§‹ï¼');
                loadGameStatus();
            } catch (error) {
                alert('å•Ÿå‹•éŠæˆ²å¤±æ•—: ' + error.message);
            }
        }

        // åœæ­¢éŠæˆ²
        async function stopGame() {
            try {
                const response = await fetch('/api/game/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: currentToken })
                });
                const result = await response.json();
                alert(result.message || 'éŠæˆ²å·²åœæ­¢ï¼');
                loadGameStatus();
            } catch (error) {
                alert('åœæ­¢éŠæˆ²å¤±æ•—: ' + error.message);
            }
        }

        // æäº¤ Flag
        async function submitFlag(event) {
            event.preventDefault();
            const flag = document.getElementById('flagInput').value.trim();
            const resultDiv = document.getElementById('flagResult');
            
            try {
                const response = await fetch('/api/flag/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: currentToken, flag })
                });
                const result = await response.json();
                
                // è™•ç†æˆåŠŸå’ŒéŒ¯èª¤å…©ç¨®æ ¼å¼
                const message = result.message || result.error || 'Unknown error';
                const isSuccess = result.success || false;
                
                resultDiv.className = 'flag-result ' + (isSuccess ? 'flag-success' : 'flag-error');
                resultDiv.textContent = isSuccess ? `âœ… ${message}` : `âŒ ${message}`;
                resultDiv.style.display = 'block';
                
                if (isSuccess) {
                    document.getElementById('flagInput').value = '';
                    loadScoreboard();
                    loadFlagHistory();
                }
                
                setTimeout(() => { resultDiv.style.display = 'none'; }, 5000);
            } catch (error) {
                resultDiv.className = 'flag-result flag-error';
                resultDiv.textContent = 'âŒ æäº¤éŒ¯èª¤: ' + error.message;
                resultDiv.style.display = 'block';
            }
        }

        // ä¸Šå‚³ Patch
        async function uploadPatch(event) {
            event.preventDefault();
            const fileInput = document.getElementById('patchFile');
            const file = fileInput.files[0];
            const statusDiv = document.getElementById('patchStatus');
            
            if (!file) {
                statusDiv.className = 'patch-status patch-error';
                statusDiv.textContent = 'âŒ è«‹é¸æ“‡æ–‡ä»¶';
                statusDiv.style.display = 'block';
                return;
            }
            
            const formData = new FormData();
            formData.append('patch', file);
            formData.append('token', currentToken);
            
            try {
                const response = await fetch('/api/patch/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                statusDiv.className = 'patch-status ' + (result.success ? 'patch-success' : 'patch-error');
                statusDiv.textContent = result.message || (result.success ? 'âœ… Patch ä¸Šå‚³æˆåŠŸï¼å°‡åœ¨ä¸‹ä¸€å›åˆå¥—ç”¨' : 'âŒ ä¸Šå‚³å¤±æ•—');
                statusDiv.style.display = 'block';
                
                if (result.success) {
                    fileInput.value = '';
                }
                
                setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
            } catch (error) {
                statusDiv.className = 'patch-status patch-error';
                statusDiv.textContent = 'âŒ ä¸Šå‚³éŒ¯èª¤: ' + error.message;
                statusDiv.style.display = 'block';
            }
        }

        // ä¸‹è¼‰ Patch
        async function downloadPatch() {
            const statusDiv = document.getElementById('patchStatus');
            
            try {
                const response = await fetch(`/api/patch/download?token=${currentToken}`);
                
                if (!response.ok) {
                    const result = await response.json();
                    statusDiv.className = 'patch-status patch-error';
                    statusDiv.textContent = 'âŒ ' + (result.message || 'ä¸‹è¼‰å¤±æ•—');
                    statusDiv.style.display = 'block';
                    setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
                    return;
                }
                
                // ä¸‹è¼‰æª”æ¡ˆ
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `team_patch_${new Date().getTime()}.py`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                statusDiv.className = 'patch-status patch-success';
                statusDiv.textContent = 'âœ… Patch ä¸‹è¼‰æˆåŠŸï¼';
                statusDiv.style.display = 'block';
                setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
            } catch (error) {
                statusDiv.className = 'patch-status patch-error';
                statusDiv.textContent = 'âŒ ä¸‹è¼‰éŒ¯èª¤: ' + error.message;
                statusDiv.style.display = 'block';
            }
        }
    </script>
</body>
</html>
